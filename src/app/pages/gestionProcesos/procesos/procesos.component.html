<nz-breadcrumb>
    <nz-breadcrumb-item>
        <a routerLink="/welcome">
            <nz-icon nzType="home" />
        </a>
    </nz-breadcrumb-item>
    <nz-breadcrumb-item>Gestion de Procesos</nz-breadcrumb-item>
</nz-breadcrumb>
<hr class="divider">
<div class="procesos-container">
    <nz-card>
        <div class="header-container">
            <h2 class="main-title">Gesti贸n de Procesos</h2>
            <div class="action-buttons">
                <button nz-button nzType="primary" (click)="toggleFormulario()"
                    nzTooltipTitle="{{isFormVisible ? 'Ocultar formulario' : 'Crear nuevo proceso'}}" nz-tooltip>
                    <i nz-icon [nzType]="isFormVisible ? 'up' : 'plus'"></i>
                    {{isFormVisible ? 'Cancelar' : 'Nuevo Proceso'}}
                </button>
                <button nz-button (click)="cargarProcesos()" nzTooltipTitle="Recargar lista de procesos" nz-tooltip>
                    <i nz-icon nzType="reload"></i>
                </button>
            </div>
        </div>

        <!-- Formulario para crear procesos -->
        <div *ngIf="isFormVisible" class="form-container" [@fadeInOut]>
            <nz-divider nzText="Nuevo Proceso"></nz-divider>
            <form nz-form [formGroup]="formProceso" (ngSubmit)="guardarProceso()">
                <!-- Nombre -->
                <nz-form-item>
                    <nz-form-label nzRequired nzFor="nombre">Nombre del Cliente</nz-form-label>
                    <nz-form-control [nzErrorTip]="nombreErrorTpl">
                        <input nz-input formControlName="nombre" id="nombre"
                            placeholder="Ingrese el nombre del cliente" />
                        <ng-template #nombreErrorTpl let-control>
                            <ng-container *ngIf="control.hasError('required')">El nombre es obligatorio</ng-container>
                            <ng-container *ngIf="control.hasError('minlength')">El nombre debe tener al menos 3
                                caracteres</ng-container>
                            <ng-container *ngIf="control.hasError('maxlength')">El nombre no debe exceder 50
                                caracteres</ng-container>
                        </ng-template>
                    </nz-form-control>
                </nz-form-item>

                <!-- C茅dula -->
                <nz-form-item>
                    <nz-form-label nzRequired nzFor="cedula">C茅dula</nz-form-label>
                    <nz-form-control [nzErrorTip]="cedulaErrorTpl">
                        <input nz-input formControlName="cedula" id="cedula" placeholder="Ingrese la c茅dula" />
                        <ng-template #cedulaErrorTpl let-control>
                            <ng-container *ngIf="control.hasError('required')">La c茅dula es obligatoria</ng-container>
                            <ng-container *ngIf="control.hasError('minlength') || control.hasError('maxlength')">La
                                c茅dula debe tener 10 d铆gitos</ng-container>
                        </ng-template>
                    </nz-form-control>
                </nz-form-item>

                <!--  Selector de descripci贸n predefinida -->
                <nz-form-item>
                    <nz-form-label nzRequired nzFor="descripcionSelector">Tipo de Proceso</nz-form-label>
                    <nz-form-control [nzErrorTip]="descripcionSelectorErrorTpl">
                        <nz-select formControlName="descripcionSelector" id="descripcionSelector" nzShowSearch nzAllowClear
                            nzPlaceHolder="Seleccione el tipo de proceso">
                            <nz-option *ngFor="let desc of descripcionesPredefinidas" [nzValue]="desc" [nzLabel]="desc">
                            </nz-option>
                        </nz-select>
                        <ng-template #descripcionSelectorErrorTpl let-control>
                            <ng-container *ngIf="control.hasError('required')">Debe seleccionar un tipo de proceso</ng-container>
                        </ng-template>
                    </nz-form-control>
                </nz-form-item>

                <!--  Input personalizado cuando se selecciona "Otro" -->
                <nz-form-item *ngIf="mostrarInputDescripcionPersonalizada">
                    <nz-form-label nzRequired nzFor="descripcion">Descripci贸n Personalizada</nz-form-label>
                    <nz-form-control [nzErrorTip]="descripcionPersonalizadaErrorTpl">
                        <textarea nz-input formControlName="descripcion" id="descripcion"
                            [nzAutosize]="{ minRows: 3, maxRows: 6 }"
                            placeholder="Ingrese la descripci贸n personalizada del proceso"></textarea>
                        <ng-template #descripcionPersonalizadaErrorTpl let-control>
                            <ng-container *ngIf="control.hasError('required')">La descripci贸n es obligatoria</ng-container>
                            <ng-container *ngIf="control.hasError('maxlength')">La descripci贸n no debe exceder 200
                                caracteres</ng-container>
                        </ng-template>
                    </nz-form-control>
                </nz-form-item>

                <!-- Materia -->
                <nz-form-item>
                    <nz-form-label nzRequired nzFor="materia">Materia</nz-form-label>
                    <nz-form-control [nzErrorTip]="materiaErrorTpl">
                        <nz-select nzShowSearch nzAllowClear nzPlaceHolder="Seleccione la materia"
                            formControlName="materia" id="materia">
                            <nz-option *ngFor="let materia of materias" [nzValue]="materia"
                                [nzLabel]="materia"></nz-option>
                        </nz-select>
                        <ng-template #materiaErrorTpl let-control>
                            <ng-container *ngIf="control.hasError('required')">La materia es obligatoria</ng-container>
                        </ng-template>
                    </nz-form-control>
                </nz-form-item>

                <!-- Fecha de Creaci贸n -->
                <nz-form-item>
                    <nz-form-label nzRequired nzFor="fechaCreacion">Fecha de Creaci贸n</nz-form-label>
                    <nz-form-control [nzErrorTip]="fechaCreacionErrorTpl">
                        <nz-date-picker formControlName="fechaCreacion" id="fechaCreacion" nzFormat="dd/MM/yyyy"
                            style="width: 100%;" nzPlaceHolder="Seleccione la fecha">
                        </nz-date-picker>
                        <ng-template #fechaCreacionErrorTpl let-control>
                            <ng-container *ngIf="control.hasError('required')">La fecha es obligatoria</ng-container>
                        </ng-template>
                    </nz-form-control>
                </nz-form-item>

                <!-- Botones del formulario -->
                <div class="form-buttons">
                    <button nz-button (click)="toggleFormulario()">Cancelar</button>
                    <button nz-button nzType="primary" [nzLoading]="isCreating" 
                        [disabled]="!formProceso.get('descripcionSelector')?.valid || !formProceso.valid">
                        <i nz-icon nzType="save"></i>
                        {{ isEditing ? 'Actualizar Proceso' : 'Guardar Proceso' }}
                    </button>
                </div>
            </form>
        </div>

        <nz-divider nzText="Lista de Procesos"></nz-divider>
        <!-- Selector de materias -->
        <div class="filters-container">
            <!-- Selector de materias (izquierda) -->
            <div class="materia-filter">
                <nz-select [(ngModel)]="materiaSeleccionada" nzShowSearch nzAllowClear
                    nzPlaceHolder="Seleccione la materia" style="min-width: 150px;"
                    (ngModelChange)="filtrarPorMateria()">
                    <nz-option nzValue="" nzLabel="Todas"></nz-option>
                    <nz-option *ngFor="let materia of materias" [nzValue]="materia" [nzLabel]="materia"></nz-option>
                </nz-select>
            </div>

            <!-- Buscador para filtrar procesos (derecha) -->
            <div class="search-container" style="width: 300px;">
                <nz-input-group [nzSuffix]="suffixIconSearch">
                    <input type="text" nz-input placeholder="Buscar procesos..." [(ngModel)]="searchValue"
                        (ngModelChange)="buscarProcesos($event)" />
                </nz-input-group>
                <ng-template #suffixIconSearch>
                    <i nz-icon nzType="search"></i>
                </ng-template>
            </div>
        </div>

        <!-- Tabla de procesos -->
        <nz-spin [nzSpinning]="isLoading">
            <nz-table #basicTable [nzBordered]="true" [nzData]="procesos" [nzLoading]="isLoading" [nzSize]="'middle'"
                [nzShowPagination]="procesos.length > 10" [nzPageSize]="10" nzShowSizeChanger
                [nzNoResult]="noResultTemplate" [nzScroll]="{ x: '1100px', y: 'calc(100vh - 300px)' }">
                <thead>
                    <tr>
                        <th nzWidth="10%">Abogado</th>
                        <th nzWidth="15%">Cliente</th>
                        <th nzWidth="10%">C茅dula</th>
                        <th nzWidth="30%">Descripci贸n</th>
                        <th nzWidth="15%">Materia</th>
                        <th nzWidth="10%">Fecha</th>
                        <th nzWidth="15%">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let proceso of basicTable.data"
                        [class.selected-row]="procesoSeleccionado?.id === proceso.id">
                        <td>{{ proceso.abogadoId }}</td>
                        <td>{{ proceso.nombre }}</td>
                        <td>{{ proceso.cedula }}</td>
                        <td>{{ proceso.descripcion }}</td>
                        <td>{{ proceso.materia }}</td>
                        <td>{{ proceso.fechaCreacion | date: 'dd/MM/yyyy HH:mm' }}</td>
                        <td>
                            <button nz-button nzType="primary" nzShape="circle" nzTooltipTitle="Ver etapas" nz-tooltip
                                (click)="seleccionarProceso(proceso)">
                                <i nz-icon [nzType]="procesoSeleccionado?.id === proceso.id ? 'up' : 'down'"></i>
                            </button>
                            <nz-divider nzType="vertical"></nz-divider>
                            <button nz-button nzType="primary" nzShape="circle" nzTooltipTitle="Editar proceso"
                                nz-tooltip (click)="toggleFormulario(proceso)">
                                <i nz-icon nzType="edit"></i>
                            </button>
                            <nz-divider nzType="vertical"></nz-divider>
                            <button nz-button nzType="primary" nzShape="circle" nzTooltipTitle="Eliminar proceso"
                                nz-tooltip nz-popconfirm nzPopconfirmTitle="驴Eliminar el proceso '{{proceso.nombre}}'?"
                                nzPopconfirmPlacement="top" nzOkText="Eliminar" nzCancelText="Cancelar"
                                (nzOnConfirm)="eliminarProceso(proceso)">
                                <i nz-icon nzType="delete"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </nz-table>

            <!-- Template para cuando no hay resultados -->
            <ng-template #noResultTemplate>
                <nz-empty
                    [nzNotFoundContent]="searchValue || materiaSeleccionada ? 'No se encontraron procesos que coincidan con los filtros' : 'No hay procesos creados'">
                </nz-empty>
            </ng-template>
        </nz-spin>
    </nz-card>

    <!-- Componente de Etapas con animaci贸n -->
    <div #etapasContent *ngIf="procesoSeleccionado" class="etapas-container" [@fadeInOut]>
        <nz-card>
            <h3 class="etapas-title">
                Etapas del proceso: <strong>{{ procesoSeleccionado.nombre }}</strong>
            </h3>
            <app-etapas [proceso]="procesoSeleccionado"></app-etapas>
        </nz-card>
    </div>
</div>