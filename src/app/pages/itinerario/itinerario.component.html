<div class="header-grid">
    <div class="header-item">
        <a routerLink="/itinerario-form" class="link">Registrar nueva actividad</a>
    </div>
    <div class="header-item">
        <a routerLink="/history-itinerario" class="link">Historial de Itinerario</a>
    </div>
</div>
<div>
    <div class="filters">
        <nz-select [formControl]="selectedArea" (ngModelChange)="filterItinerarios()" nzPlaceHolder="Filtrar por área">
            <nz-option *ngFor="let area of areas" [nzValue]="area" [nzLabel]="area"></nz-option>
        </nz-select>
        <nz-range-picker [formControl]="selectedDate" (ngModelChange)="filterItinerarios()"></nz-range-picker>
        <button nz-button nzType="default" (click)="showAllAreas()">Mostrar todas</button>
    </div>
    <nz-table class="itinerario-table" #rowSelectionTable nzBordered nzShowPagination nzShowSizeChanger
        [nzData]="filteredItinerarios" [nzLoading]="loading"
        (nzCurrentPageDataChange)="onCurrentPageDataChange($event)">
        <thead>
            <tr>
                <th nzWidth="5%">Estado</th>
                <th nzWidth="10%">Área</th>
                <th nzWidth="5%">Juzgado</th>
                <th nzWidth="5%">Piso</th>
                <th nzWidth="12%">Trámite</th>
                <th nzWidth="10%">Solicitante</th>
                <th nzWidth="10%">Fecha de Solicitud</th>
                <th nzWidth="10%">Fecha de Término</th>
                <th nzWidth="8%">Observaciones</th>
                <th nzWidth="8%">Documentos</th>
                <th nzWidth="6%">Fecha Completado</th>
                <th nzWidth="5%">Hora Completado</th>
                <th nzWidth="6%">Obs. Completado</th>
                <th nzWidth="6%">Acciones</th>
            </tr>
        </thead>
        <tbody *ngIf="rowSelectionTable.data && rowSelectionTable.data.length > 0; else emptyTable">
            <tr *ngFor="let item of rowSelectionTable.data; trackBy: trackById">
                <td>
                    <nz-tag [nzColor]="getEstadoColor(item.estado)">
                        {{ getEstadoTexto(item.estado) }}
                    </nz-tag>
                </td>
                <td>{{ item.area }}</td>
                <td>{{ item.juzgado }}</td>
                <td>{{ item.piso }}</td>
                <td>{{ item.tramite }}</td>
                <td>{{ item.solicita }}</td>
                <td>{{ item.fechaSolicitud }}</td>
                <td>{{ item.fechaTermino }}</td>
                <td>{{ item.observaciones }}</td>
                <td>
                    <ng-container *ngIf="item.imagen || item.pdf; else noData">
                        <!-- Mostrar imagen si existe -->
                        <a *ngIf="item.imagen" [href]="item.imagen" target="_blank">
                            <img [src]="item.imagen" alt="Imagen" width="100" style="cursor: pointer;">
                        </a>

                        <!-- Mostrar enlace de descarga si hay PDF -->
                        <a *ngIf="item.pdf" [href]="item.pdf" download="documento.pdf" target="_blank"
                            style="color: rgb(190, 31, 31);">
                            <i nz-icon nzType="download"></i>Descargar PDF
                        </a>
                    </ng-container>

                    <!-- Caso cuando no hay imagen ni PDF -->
                    <ng-template #noData>
                        N/A
                    </ng-template>
                </td>
                <td>{{ item.fechaCompletado }}</td>
                <td>{{ item.horaCompletado }}</td>
                <td>
                    <!-- Mostrar la observación completada -->
                    <span>{{ item.obsCompletado }}</span>

                    <!-- Mostrar el botón solo si hay historial -->
                    <button nz-button nzType="link" (click)="verHistorial(item)">
                        Ver Historial
                    </button>
                </td>
                <td>
                    <ng-container>
                        <!-- Botón "Completado" (siempre visible) -->
                        <button nz-button nzType="primary"
                                (click)="setEstado(item, Estado.COMPLETADO)">
                            Completado
                        </button>
                
                        <!-- Botón "En Proceso" (siempre visible) -->
                        <button nz-button nzType="default"
                                (click)="setEstado(item, Estado.INCOMPLETO)">
                            En Proceso
                        </button>
                    </ng-container>
                </td>
            </tr>
        </tbody>

        <!-- Template para cuando no hay datos -->
        <ng-template #emptyTable>
            <tbody></tbody>
        </ng-template>
    </nz-table>
</div>

<!-- Modal de Formulario -->
<nz-modal [(nzVisible)]="isVisible" nzTitle="Detalles de Finalización" [nzFooter]="modalFooter"
    (nzOnCancel)="handleCancel()">
    <ng-container *nzModalContent>
        <form nz-form>
            <nz-form-item>
                <nz-form-label nzFor="observaciones">Observaciones</nz-form-label>
                <nz-form-control>
                    <textarea nz-input [(ngModel)]="selectedItem.obsCompletado" (input)="validarFormulario()"
                        id="observaciones" name="observaciones" placeholder="Ingrese observaciones" rows="4"></textarea>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item>
                <nz-form-label nzFor="fotografia">Fotografía</nz-form-label>
                <nz-form-control>
                    <nz-upload nzListType="picture" nzAccept="image/*" [nzShowUploadList]="true"
                        [(nzFileList)]="imageFileList" (nzChange)="onFileSelected($event)">
                        <button nz-button>
                            <i nz-icon nzType="upload"></i> Subir Imagen
                        </button>
                    </nz-upload>
                </nz-form-control>
            </nz-form-item>
        </form>
    </ng-container>

    <ng-template #modalFooter>
        <button nz-button nzDanger="true" (click)="handleCancel()">
            <i nz-icon nzType="close"></i> Cancelar
        </button>
        <button nz-button nzType="primary" (click)="guardarEstado()" [nzLoading]="isConfirmLoading">
            <i nz-icon nzType="save"></i> Guardar
        </button>
    </ng-template>
</nz-modal>

<!-- Modal de Historial -->
<nz-modal [(nzVisible)]="isHistorialVisible" nzTitle="Historial de Observaciones" (nzOnCancel)="cerrarHistorial()"
    [nzFooter]="null">
    <ng-container *nzModalContent>
        <nz-list>
            <nz-list-item *ngFor="let entrada of historialActual">
                <strong *ngIf="entrada.nombre || entrada.email">
                    User: {{ entrada.nombre || entrada.email || entrada.uid }}
                </strong>
                <p>{{ entrada.observacion }}</p>
                <p>{{ entrada.fecha }} {{ entrada.hora }}</p>
            </nz-list-item>
        </nz-list>
    </ng-container>
</nz-modal>